#!/usr/bin/env bash
#
# ff-launcher-history - Browse Firefox history
#
# Interactively select a URL from Firefox history and open it.
#
# Dependencies: fzf, sqlite3
#
. "$(dirname "$(readlink -f "$0")")/ff-launcher-lib.sh"

require fzf sqlite3

db="$(ff_profile_dir)/places.sqlite"
[[ -f "$db" ]] || die "History database not found"

list_history() {
  sqlite3 "file:$db?immutable=1" "
    SELECT datetime(v.visit_date/1000000, 'unixepoch', 'localtime')
      || ' ' || p.url
    FROM moz_places p
    JOIN moz_historyvisits v ON p.id = v.place_id
    ORDER BY v.visit_date DESC
    LIMIT 100000
  "
}

target="$(list_history | fzf "${FZF_OPTS[@]}")" \
  || exit 0
url="${target#* }"
url="${url#* }"
setsid firefox "$url" >/dev/null 2>&1
